<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="style.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat app</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"
      integrity="sha512-Xm9qbB6Pu06k3PUwPj785dyTl6oHxgsv9nHp7ej7nCpAqGZT3OZpsELuCYX05DdonFpTlBpXMOxjavIAIUwr0w=="
      crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  </head>
  <body>
    <main>
      <form class="form-join" id="joinForm">
        <input type="text" id="name" maxlength="8" placeholder="Your name" size="5" required />
        <input type="text" id="room" placeholder="Chat room" size="5" required />
        <button type="submit">Join</button>
      </form>

      <ul class="chat-display" id="messageList">
        <!-- Existing messages will be added here -->
      </ul>

      <ul class="chat-display">
        <li class="user-list"></li>
        <li class="room-list"></li>
        <li class="activity"></li>
      </ul>

      <form class="form-msg" id="messageForm">
        <input type="text" id="message" placeholder="Your message" required>
        <button type="submit">Send</button>
      </form>
    </main>
    <script>
      const socket = io('ws://localhost:3000');

      const nameInput = document.getElementById('name');
      const chatRoom = document.getElementById('room');
      const activity = document.querySelector('.activity');
      const usersList = document.querySelector('.user-list');
      const roomList = document.querySelector('.room-list');
      const chatDisplay = document.getElementById('messageList');
      const messageInput = document.getElementById('message');

      function sendMessage(e) {
          e.preventDefault();
          if (nameInput.value && messageInput.value && chatRoom.value) {
              socket.emit('message', {
                  name: nameInput.value,
                  text: messageInput.value
              });
              messageInput.value = '';
          }
          messageInput.focus();
      }

      function enterRoom(e) {
          e.preventDefault();
          if (nameInput.value && chatRoom.value) {
              socket.emit('enterRoom', {
                  name: nameInput.value,
                  room: chatRoom.value
              });
          }
      }

      document.getElementById('messageForm').addEventListener('submit', sendMessage);
      document.getElementById('joinForm').addEventListener('submit', enterRoom);

      messageInput.addEventListener('keypress', () => {
          socket.emit('activity', nameInput.value);
      });

      // Listen for messages
      socket.on('message', (data) => {
          activity.textContent = '';
          const { name, text, time } = data;
          const li = document.createElement('li');
          li.className = 'post';
          if (name === nameInput.value) li.className = 'post post--left';
          if (name !== nameInput.value && name !== 'Admin') li.className = 'post post--right';
          if (name !== 'Admin') {
              li.innerHTML = `<div class="post__header ${
                  name === nameInput.value ? 'post__header--user' : 'post__header--reply'
              }">
              <span class="post__header--name">${name}</span>
              <span class="post__header--time">${time}</span>
              </div>
              <div class="post__text">${text}</div>`;
          } else {
              li.innerHTML = `<div class="post__text">${text}</div>`;
          }
          chatDisplay.appendChild(li);

          chatDisplay.scrollTop = chatDisplay.scrollHeight;
      });

      let activityTimer;
      socket.on('activity', (name) => {
          activity.textContent = `${name} is typing...`;

          // Clear after 3 seconds
          clearTimeout(activityTimer);
          activityTimer = setTimeout(() => {
              activity.textContent = '';
          }, 3000);
      });

      socket.on('userList', ({ users }) => {
          showUsers(users);
      });

      socket.on('roomList', ({ rooms }) => {
          showRooms(rooms);
      });

      function showUsers(users) {
          usersList.textContent = '';
          if (users) {
              usersList.innerHTML = `<em>Users in ${chatRoom.value}:</em>`;
              users.forEach((user, i) => {
                  usersList.textContent += ` ${user.name}`;
                  if (users.length > 1 && i !== users.length - 1) {
                      usersList.textContent += ',';
                  }
              });
          }
      }

      function showRooms(rooms) {
          roomList.textContent = '';
          if (rooms) {
              roomList.innerHTML = '<em>Active Rooms:</em>';
              rooms.forEach((room, i) => {
                  roomList.textContent += ` ${room}`;
                  if (rooms.length > 1 && i !== rooms.length - 1) {
                      roomList.textContent += ',';
                  }
              });
          }
      }
    </script>
  </body>
</html>
